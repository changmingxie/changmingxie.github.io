{
  "filename": "quickstart.md",
  "__html": "<h1 id=\"%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B\">快速开始 <a class=\"header-anchor\" href=\"#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B\">#</a></h1>\n<p>让我们从一个简单的示例开始！</p>\n<h2 id=\"%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E\">示例说明 <a class=\"header-anchor\" href=\"#%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E\">#</a></h2>\n<p>在该示例中，我们将账户(Account)作为<strong>聚合根</strong>，子账户(SubAccount)作为<strong>领域对象</strong>，一个账户下可以存在若干个子账户。在为用户创建账户时，会借助<strong>事件</strong>来对账户进行初始化。</p>\n<h2 id=\"%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4\">搭建步骤 <a class=\"header-anchor\" href=\"#%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4\">#</a></h2>\n<p>1.新建一个springboot项目，添加maven依赖</p>\n<pre><code class=\"language-xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependencies</span>&gt;</span>\n    <span class=\"hljs-comment\">&lt;!--需要先在本地install aggregate-framework项目--&gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.aggregateframework<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>aggregate-framework-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>4.0.0-SNAPSHOT<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>2.2.13.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n    \n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.mybatis.spring.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>2.1.4<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n    \n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.h2database<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>h2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.4.197<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>spring-boot-starter-aop<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>2.2.13.RELEASE<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>com.google.guava<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>guava<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>19.0<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n    \n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>org.projectlombok<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>lombok<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>1.18.16<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependencies</span>&gt;</span>\n</code></pre>\n<p>2.以org.aggregateframework.basic.usage为根目录，在根目录下新建启动类<br>\nBasicUsageApplication.java</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage;\n\n<span class=\"hljs-keyword\">import</span> org.mybatis.spring.annotation.MapperScan;\n<span class=\"hljs-keyword\">import</span> org.springframework.boot.SpringApplication;\n<span class=\"hljs-keyword\">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;\n\n<span class=\"hljs-meta\">@SpringBootApplication</span>\n<span class=\"hljs-meta\">@MapperScan</span>(<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.dao\"</span>)\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BasicUsageApplication</span> </span>{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{\n        SpringApplication.run(BasicUsageApplication<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>, <span class=\"hljs-title\">args</span>)</span>;\n    }\n}\n</code></pre>\n<p>3.新建entity目录，创建Account和SubAccount对象<br>\nAccount.java</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.entity;\n\n<span class=\"hljs-keyword\">import</span> lombok.*;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.event.AccountCreateEvent;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.entity.AbstractSimpleAggregateRoot;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.entity.DaoAwareQuery;\n\n<span class=\"hljs-keyword\">import</span> java.util.ArrayList;\n<span class=\"hljs-keyword\">import</span> java.util.List;\n\n<span class=\"hljs-comment\">/**\n * Account类继承自AbstractSimpleAggregateRoot，代表它是一个聚合根。\n * 使用<span class=\"hljs-doctag\">@DaoAwareQuery</span>来表示在查找Account时，如何获取其关联的领域对象\n */</span>\n<span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-meta\">@EqualsAndHashCode</span>(callSuper = <span class=\"hljs-keyword\">true</span>)\n<span class=\"hljs-meta\">@Builder</span>\n<span class=\"hljs-meta\">@AllArgsConstructor</span>\n<span class=\"hljs-meta\">@NoArgsConstructor</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Account</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractSimpleAggregateRoot</span>&lt;<span class=\"hljs-title\">Long</span>&gt; </span>{\n\n    <span class=\"hljs-keyword\">private</span> Long id;\n\n    <span class=\"hljs-keyword\">private</span> String accountId;\n\n    <span class=\"hljs-keyword\">private</span> Integer eventStatus;\n\n    <span class=\"hljs-meta\">@DaoAwareQuery</span>(mappedBy = <span class=\"hljs-string\">\"account\"</span>, select = <span class=\"hljs-string\">\"findByParentId\"</span>)\n    <span class=\"hljs-keyword\">private</span> List&lt;SubAccount&gt; subAccounts = <span class=\"hljs-keyword\">new</span> ArrayList&lt;&gt;();\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">applyAccountCreateEvent</span><span class=\"hljs-params\">()</span></span>{\n        apply(<span class=\"hljs-keyword\">new</span> AccountCreateEvent(accountId));\n    }\n}\n\n</code></pre>\n<p>SubAccount.java</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.entity;\n\n<span class=\"hljs-keyword\">import</span> lombok.*;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.entity.AbstractSimpleDomainObject;\n\n<span class=\"hljs-comment\">/**\n * SubAccount类继承自AbstractSimpleAggregateRoot，代表它是一个领域对象。\n */</span>\n<span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-meta\">@EqualsAndHashCode</span>(callSuper = <span class=\"hljs-keyword\">true</span>)\n<span class=\"hljs-meta\">@Builder</span>\n<span class=\"hljs-meta\">@AllArgsConstructor</span>\n<span class=\"hljs-meta\">@NoArgsConstructor</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SubAccount</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractSimpleDomainObject</span>&lt;<span class=\"hljs-title\">Long</span>&gt; </span>{\n\n    <span class=\"hljs-keyword\">private</span> Long id;\n\n    <span class=\"hljs-keyword\">private</span> String accountId;\n\n    <span class=\"hljs-keyword\">private</span> Account account;\n\n    <span class=\"hljs-keyword\">private</span> Integer eventStatus;\n}\n</code></pre>\n<p>4.添加仓储层代码<br>\n新建dao目录，创建AccountDao和SubAccountDao对象<br>\nAccountDao.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.dao;\n\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.Account;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.dao.AggregateRootDao;\n<span class=\"hljs-keyword\">import</span> org.apache.ibatis.annotations.Param;\n\n<span class=\"hljs-keyword\">import</span> java.util.List;\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">AccountDao</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AggregateRootDao</span>&lt;<span class=\"hljs-title\">Account</span>,<span class=\"hljs-title\">Long</span>&gt; </span>{\n\n    <span class=\"hljs-function\">Account <span class=\"hljs-title\">findByAccountId</span><span class=\"hljs-params\">(@Param(<span class=\"hljs-string\">\"accountId\"</span>)</span> String accountId)</span>;\n\n    <span class=\"hljs-function\">List&lt;Account&gt; <span class=\"hljs-title\">findByAccountIds</span><span class=\"hljs-params\">(List&lt;String&gt; accountIds)</span></span>;\n}\n</code></pre>\n<p>SubAccountDao.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.dao;\n\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.SubAccount;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.dao.DomainObjectDao;\n<span class=\"hljs-keyword\">import</span> org.apache.ibatis.annotations.Param;\n\n<span class=\"hljs-keyword\">import</span> java.util.List;\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title\">SubAccountDao</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">DomainObjectDao</span>&lt;<span class=\"hljs-title\">SubAccount</span>,<span class=\"hljs-title\">Long</span>&gt; </span>{\n\n    <span class=\"hljs-function\">List&lt;SubAccount&gt; <span class=\"hljs-title\">findByParentId</span><span class=\"hljs-params\">(@Param(<span class=\"hljs-string\">\"parentId\"</span>)</span> Long parentId)</span>;\n}\n</code></pre>\n<p>在resources目录下新建mapping目录，添加对应的XML文件<br>\nAccountMapper.xml</p>\n<pre><code class=\"language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" ?&gt;</span>\n<span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">mapper</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-meta-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span> &gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">mapper</span> <span class=\"hljs-attr\">namespace</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.dao.AccountDao\"</span> &gt;</span>\n    \n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resultMap</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"baseResultMap\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.Account\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"id\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"ID\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"accountId\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"ACCOUNT_ID\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"eventStatus\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"EVENT_STATUS\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"createTime\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"CREATE_TIME\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"lastUpdateTime\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"LAST_UPDATE_TIME\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"version\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"VERSION\"</span>/&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">resultMap</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">sql</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"sql_select\"</span>&gt;</span>\n        SELECT ID,\n               ACCOUNT_ID,\n               EVENT_STATUS,\n               VERSION,\n               CREATE_TIME,\n               LAST_UPDATE_TIME\n        FROM ACCOUNT\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">sql</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findAll\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findById\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n\t\tWHERE ID=#{id}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findByAccountId\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n        WHERE ACCOUNT_ID=#{accountId}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findByAccountIds\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n        WHERE ACCOUNT_ID in \n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">foreach</span> <span class=\"hljs-attr\">item</span>=<span class=\"hljs-string\">\"item\"</span> <span class=\"hljs-attr\">index</span>=<span class=\"hljs-string\">\"index\"</span> <span class=\"hljs-attr\">collection</span>=<span class=\"hljs-string\">\"list\"</span> <span class=\"hljs-attr\">separator</span>=<span class=\"hljs-string\">\",\"</span> <span class=\"hljs-attr\">open</span>=<span class=\"hljs-string\">\"(\"</span> <span class=\"hljs-attr\">close</span>=<span class=\"hljs-string\">\")\"</span>&gt;</span>\n            #{item}\n        <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">foreach</span>&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">insert</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"insert\"</span> <span class=\"hljs-attr\">useGeneratedKeys</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">keyProperty</span>=<span class=\"hljs-string\">\"id\"</span> <span class=\"hljs-attr\">keyColumn</span>=<span class=\"hljs-string\">\"ID\"</span> <span class=\"hljs-attr\">parameterType</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.Account\"</span>&gt;</span>\n        INSERT INTO ACCOUNT\n            (ACCOUNT_ID,EVENT_STATUS,VERSION,CREATE_TIME,LAST_UPDATE_TIME)\n        VALUES\n            (#{accountId},#{eventStatus},#{version},#{createTime},#{lastUpdateTime})\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">insert</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">update</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"update\"</span> <span class=\"hljs-attr\">parameterType</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.Account\"</span>&gt;</span>\n        UPDATE\n        `ACCOUNT`\n        SET\n        ACCOUNT_ID=#{accountId},\n        EVENT_STATUS=#{eventStatus},\n        VERSION=#{version},\n        LAST_UPDATE_TIME=#{lastUpdateTime}\n        WHERE ID=#{id}\n        AND VERSION=#{version}-1\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">update</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">delete</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"delete\"</span>&gt;</span>\n        DELETE FROM ACCOUNT WHERE ID=#{id}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">delete</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">mapper</span>&gt;</span>\n</code></pre>\n<p>SubAccountMapper.xml</p>\n<pre><code class=\"language-xml\"><span class=\"hljs-meta\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\" ?&gt;</span>\n<span class=\"hljs-meta\">&lt;!DOCTYPE <span class=\"hljs-meta-keyword\">mapper</span> <span class=\"hljs-meta-keyword\">PUBLIC</span> <span class=\"hljs-meta-string\">\"-//mybatis.org//DTD Mapper 3.0//EN\"</span> <span class=\"hljs-meta-string\">\"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"</span> &gt;</span>\n<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">mapper</span> <span class=\"hljs-attr\">namespace</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.dao.SubAccountDao\"</span> &gt;</span>\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">resultMap</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"baseResultMap\"</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.SubAccount\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"id\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"ID\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"accountId\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"ACCOUNT_ID\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"account.id\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"PARENT_ID\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"eventStatus\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"EVENT_STATUS\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"createTime\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"CREATE_TIME\"</span>/&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">result</span> <span class=\"hljs-attr\">property</span>=<span class=\"hljs-string\">\"lastUpdateTime\"</span> <span class=\"hljs-attr\">column</span>=<span class=\"hljs-string\">\"LAST_UPDATE_TIME\"</span>/&gt;</span>\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">resultMap</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">sql</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"sql_select\"</span>&gt;</span>\n        SELECT ID,\n               ACCOUNT_ID,\n               PARENT_ID,\n               EVENT_STATUS,\n               CREATE_TIME,\n               LAST_UPDATE_TIME\n        FROM SUB_ACCOUNT\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">sql</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findById\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n        WHERE ID=#{id}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">select</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"findByParentId\"</span> <span class=\"hljs-attr\">resultMap</span>=<span class=\"hljs-string\">\"baseResultMap\"</span>&gt;</span>\n        <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">include</span> <span class=\"hljs-attr\">refid</span>=<span class=\"hljs-string\">\"sql_select\"</span>/&gt;</span>\n        WHERE PARENT_ID = #{parentId}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">select</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">insert</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"insert\"</span> <span class=\"hljs-attr\">useGeneratedKeys</span>=<span class=\"hljs-string\">\"true\"</span> <span class=\"hljs-attr\">keyProperty</span>=<span class=\"hljs-string\">\"id\"</span> <span class=\"hljs-attr\">keyColumn</span>=<span class=\"hljs-string\">\"ID\"</span> <span class=\"hljs-attr\">parameterType</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.SubAccount\"</span>&gt;</span>\n        INSERT INTO SUB_ACCOUNT\n            (ACCOUNT_ID,PARENT_ID,EVENT_STATUS,CREATE_TIME,LAST_UPDATE_TIME)\n        VALUES\n        (#{accountId},#{account.id},#{eventStatus},#{createTime},#{lastUpdateTime})\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">insert</span>&gt;</span>\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">update</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"update\"</span> <span class=\"hljs-attr\">parameterType</span>=<span class=\"hljs-string\">\"org.aggregateframework.basic.usage.entity.SubAccount\"</span>&gt;</span>\n        UPDATE\n            `SUB_ACCOUNT`\n        SET\n            ACCOUNT_ID=#{accountId},\n            PARENT_ID=#{account.id},\n            EVENT_STATUS=#{eventStatus},\n            LAST_UPDATE_TIME=#{lastUpdateTime}\n        WHERE ID=#{id}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">update</span>&gt;</span>\n\n\n    <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">delete</span> <span class=\"hljs-attr\">id</span>=<span class=\"hljs-string\">\"delete\"</span>&gt;</span>\n        DELETE FROM\n            SUB_ACCOUNT WHERE ID=#{id}\n    <span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">delete</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">mapper</span>&gt;</span>\n</code></pre>\n<p>新建repository目录，为聚合根添加Repository<br>\nAccountRepository.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.repository;\n\n\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.dao.AccountDao;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.Account;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.repository.DaoAwareAggregateRepository;\n<span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;\n<span class=\"hljs-keyword\">import</span> org.springframework.stereotype.Repository;\n\n<span class=\"hljs-keyword\">import</span> java.util.List;\n\n<span class=\"hljs-meta\">@Repository</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AccountRepository</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">DaoAwareAggregateRepository</span>&lt;<span class=\"hljs-title\">Account</span>,<span class=\"hljs-title\">Long</span>&gt; </span>{\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-keyword\">private</span> AccountDao accountDao;\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">AccountRepository</span><span class=\"hljs-params\">()</span> </span>{\n        <span class=\"hljs-keyword\">super</span>(Account<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)</span>;\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Account <span class=\"hljs-title\">findByAccountId</span><span class=\"hljs-params\">(String accountId)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> fetchAllComponents(accountDao.findByAccountId(accountId));\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;Account&gt; <span class=\"hljs-title\">findByAccountIds</span><span class=\"hljs-params\">(List&lt;String&gt; accountIds)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> fetchAllComponents(accountDao.findByAccountIds(accountIds));\n    }\n}\n\n</code></pre>\n<p>5.新建event目录，添加事件和事件处理器<br>\nAccountCreateEvent.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.event;\n\n<span class=\"hljs-keyword\">import</span> lombok.AllArgsConstructor;\n<span class=\"hljs-keyword\">import</span> lombok.Data;\n<span class=\"hljs-keyword\">import</span> lombok.NoArgsConstructor;\n\n<span class=\"hljs-meta\">@Data</span>\n<span class=\"hljs-meta\">@NoArgsConstructor</span>\n<span class=\"hljs-meta\">@AllArgsConstructor</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AccountCreateEvent</span> </span>{\n\n    <span class=\"hljs-keyword\">private</span> String accountId;\n}\n</code></pre>\n<p>AccountEventHandler.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.event;\n\n<span class=\"hljs-keyword\">import</span> lombok.extern.slf4j.Slf4j;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.Account;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.repository.AccountRepository;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.eventhandling.annotation.AsyncConfig;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.eventhandling.annotation.EventHandler;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.eventhandling.annotation.QueueFullPolicy;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.eventhandling.annotation.TransactionCheck;\n<span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;\n<span class=\"hljs-keyword\">import</span> org.springframework.stereotype.Component;\n<span class=\"hljs-keyword\">import</span> org.springframework.transaction.annotation.Transactional;\n\n<span class=\"hljs-keyword\">import</span> java.util.List;\n<span class=\"hljs-keyword\">import</span> java.util.stream.Collectors;\n\n<span class=\"hljs-comment\">/**\n * 使用<span class=\"hljs-doctag\">@EventHandler</span>创建事件处理器，此处通过修改账户的状态位来模拟对账户的初始化操作。\n */</span>\n<span class=\"hljs-meta\">@Component</span>\n<span class=\"hljs-meta\">@Slf</span>4j\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AccountEventHandler</span> </span>{\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-keyword\">private</span> AccountRepository accountRepository;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> Integer AGG_EVENT_STATUS_POS_1 = <span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">0</span>;\n\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> Integer AGG_EVENT_STATUS_POS_2 = <span class=\"hljs-number\">1</span> &lt;&lt; <span class=\"hljs-number\">1</span>;\n\n    <span class=\"hljs-meta\">@EventHandler</span>(asynchronous = <span class=\"hljs-keyword\">true</span>, postAfterTransaction = <span class=\"hljs-keyword\">true</span>, isTransactionMessage = <span class=\"hljs-keyword\">true</span>,\n            asyncConfig = <span class=\"hljs-meta\">@AsyncConfig</span>(queueFullPolicy = QueueFullPolicy.DISCARD),\n            transactionCheck = <span class=\"hljs-meta\">@TransactionCheck</span>(checkTransactionStatusMethod = <span class=\"hljs-string\">\"checkAccountCreateEvent\"</span>))\n    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)\n    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">handleAccountCreateEvent</span>(<span class=\"hljs-title\">AccountCreateEvent</span> <span class=\"hljs-title\">accountCreateEvent</span>) </span>{\n        log.info(<span class=\"hljs-string\">\"exec handleAccountCreateEvent，{}\"</span>, accountCreateEvent);\n        Account account = accountRepository.findByAccountId(accountCreateEvent.getAccountId());\n        <span class=\"hljs-keyword\">if</span> (account != <span class=\"hljs-keyword\">null</span>) {\n            account.setEventStatus(account.getEventStatus() | AGG_EVENT_STATUS_POS_1);\n            account.getSubAccounts().forEach(each -&gt; each.setEventStatus(each.getEventStatus() | AGG_EVENT_STATUS_POS_1));\n        }\n        accountRepository.save(account);\n    }\n\n    <span class=\"hljs-meta\">@EventHandler</span>(asynchronous = <span class=\"hljs-keyword\">true</span>, postAfterTransaction = <span class=\"hljs-keyword\">true</span>, isTransactionMessage = <span class=\"hljs-keyword\">true</span>,\n            asyncConfig = <span class=\"hljs-meta\">@AsyncConfig</span>(queueFullPolicy = QueueFullPolicy.DISCARD),\n            transactionCheck = <span class=\"hljs-meta\">@TransactionCheck</span>(checkTransactionStatusMethod = <span class=\"hljs-string\">\"batchCheckAccountCreateEvent\"</span>))\n    <span class=\"hljs-meta\">@Transactional</span>(rollbackFor = Throwable<span class=\"hljs-class\">.<span class=\"hljs-keyword\">class</span>)\n    <span class=\"hljs-title\">public</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-title\">batchHandleAccountCreateEvent</span>(<span class=\"hljs-title\">List</span>&lt;<span class=\"hljs-title\">AccountCreateEvent</span>&gt; <span class=\"hljs-title\">accountCreateEvents</span>) </span>{\n        log.info(<span class=\"hljs-string\">\"exec batchHandleAccountCreateEvent，{}\"</span>, accountCreateEvents);\n        List&lt;Account&gt; accounts = accountRepository.findByAccountIds(accountCreateEvents.stream().map(AccountCreateEvent::getAccountId).collect(Collectors.toList()));\n        accounts.forEach(account -&gt; {\n            account.setEventStatus(account.getEventStatus() | AGG_EVENT_STATUS_POS_2);\n            account.getSubAccounts().forEach(each -&gt; each.setEventStatus(each.getEventStatus() | AGG_EVENT_STATUS_POS_2));\n        });\n        accountRepository.save(accounts);\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">checkAccountCreateEvent</span><span class=\"hljs-params\">(AccountCreateEvent accountCreateEvent)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> accountRepository.findByAccountId(accountCreateEvent.getAccountId()) != <span class=\"hljs-keyword\">null</span>;\n    }\n\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">batchCheckAccountCreateEvent</span><span class=\"hljs-params\">(List&lt;AccountCreateEvent&gt; accountCreateEvents)</span> </span>{\n        <span class=\"hljs-keyword\">return</span> !accountRepository.findByAccountIds(accountCreateEvents.stream().map(AccountCreateEvent::getAccountId).collect(Collectors.toList())).isEmpty();\n    }\n}\n</code></pre>\n<p>6.新建controller目录，添加供外部创建账户的api<br>\nAccountController.class</p>\n<pre><code class=\"language-java\"><span class=\"hljs-keyword\">package</span> org.aggregateframework.basic.usage.controller;\n\n<span class=\"hljs-keyword\">import</span> com.alibaba.fastjson.JSON;\n<span class=\"hljs-keyword\">import</span> lombok.extern.slf4j.Slf4j;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.Account;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.entity.SubAccount;\n<span class=\"hljs-keyword\">import</span> org.aggregateframework.basic.usage.repository.AccountRepository;\n<span class=\"hljs-keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;\n<span class=\"hljs-keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;\n<span class=\"hljs-keyword\">import</span> org.springframework.web.bind.annotation.RequestMapping;\n<span class=\"hljs-keyword\">import</span> org.springframework.web.bind.annotation.RequestParam;\n<span class=\"hljs-keyword\">import</span> org.springframework.web.bind.annotation.RestController;\n\n<span class=\"hljs-keyword\">import</span> java.util.List;\n<span class=\"hljs-keyword\">import</span> java.util.UUID;\n<span class=\"hljs-keyword\">import</span> java.util.stream.Collectors;\n<span class=\"hljs-keyword\">import</span> java.util.stream.IntStream;\n\n<span class=\"hljs-meta\">@Slf</span>4j\n<span class=\"hljs-meta\">@RestController</span>\n<span class=\"hljs-meta\">@RequestMapping</span>(<span class=\"hljs-string\">\"/account\"</span>)\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AccountController</span> </span>{\n\n    <span class=\"hljs-meta\">@Autowired</span>\n    <span class=\"hljs-keyword\">private</span> AccountRepository accountRepository;\n\n    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/create\"</span>)\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">create</span><span class=\"hljs-params\">(@RequestParam(defaultValue = <span class=\"hljs-string\">\"1\"</span>)</span> Integer amount) </span>{\n        String accountId = UUID.randomUUID().toString().replace(<span class=\"hljs-string\">\"-\"</span>, <span class=\"hljs-string\">\"\"</span>);\n        Account account = Account.builder()\n                .accountId(accountId)\n                .eventStatus(<span class=\"hljs-number\">0</span>)\n                .build();\n        List&lt;SubAccount&gt; subAccounts = IntStream.range(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>).mapToObj(each -&gt; SubAccount.builder()\n                .accountId(accountId + <span class=\"hljs-string\">\"-\"</span> + each)\n                .account(account)\n                .eventStatus(<span class=\"hljs-number\">0</span>)\n                .build()).collect(Collectors.toList());\n        account.setSubAccounts(subAccounts);\n        account.applyAccountCreateEvent();\n        accountRepository.save(account);\n        <span class=\"hljs-keyword\">return</span> accountId;\n    }\n\n    <span class=\"hljs-meta\">@GetMapping</span>(<span class=\"hljs-string\">\"/query\"</span>)\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">query</span><span class=\"hljs-params\">(@RequestParam(<span class=\"hljs-string\">\"accountId\"</span>)</span> String accountId)</span>{\n        <span class=\"hljs-keyword\">return</span> JSON.toJSONString(accountRepository.findByAccountId(accountId));\n    }\n}\n</code></pre>\n<p>7.部署配置<br>\n在resources目录下，添加项目配置文件<br>\napplication.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8080</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/${spring.application.name}</span>\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-basic-usage</span>\n  <span class=\"hljs-attr\">profiles:</span>\n    <span class=\"hljs-attr\">active:</span> <span class=\"hljs-string\">local</span>  <span class=\"hljs-comment\"># Possible values: local, server</span>\n  <span class=\"hljs-comment\">#使用h2数据库，存储业务数据</span>\n  <span class=\"hljs-attr\">datasource:</span>\n    <span class=\"hljs-attr\">driver-class-name:</span> <span class=\"hljs-string\">org.h2.Driver</span>\n    <span class=\"hljs-attr\">url:</span> <span class=\"hljs-string\">jdbc:h2:mem:AGG_TEST</span>\n    <span class=\"hljs-attr\">username:</span> <span class=\"hljs-string\">root</span>\n    <span class=\"hljs-attr\">password:</span> <span class=\"hljs-string\">welcome1</span>\n    <span class=\"hljs-attr\">initialization-mode:</span> <span class=\"hljs-string\">always</span>\n    <span class=\"hljs-attr\">schema:</span> <span class=\"hljs-string\">classpath:schema.sql</span>\n  <span class=\"hljs-comment\">#h2数据库控台地址 http://localhost:8080/aggregate-framework-basic-usage/h2-console</span>\n  <span class=\"hljs-attr\">h2:</span>\n    <span class=\"hljs-attr\">console:</span>\n      <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">settings:</span>\n        <span class=\"hljs-attr\">web-allow-others:</span> <span class=\"hljs-literal\">true</span>\n<span class=\"hljs-attr\">mybatis:</span>\n  <span class=\"hljs-attr\">mapper-locations:</span> <span class=\"hljs-string\">classpath:mapping/*.xml</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n</code></pre>\n<p>application-local.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\">#embedded模式额外配置</span>\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">redis</span>\n      <span class=\"hljs-attr\">domain:</span> <span class=\"hljs-string\">\"AGG:TEST:CLIENT:\"</span>\n      <span class=\"hljs-attr\">serializer-type:</span> <span class=\"hljs-string\">kryo</span>\n      <span class=\"hljs-attr\">redis:</span>\n        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">6379</span>\n        <span class=\"hljs-attr\">database:</span> <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-attr\">pool-config:</span>\n          <span class=\"hljs-attr\">max-total:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">max-idle:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">min-idle:</span> <span class=\"hljs-number\">10</span>\n          <span class=\"hljs-attr\">max-wait-millis:</span> <span class=\"hljs-number\">300</span>\n    <span class=\"hljs-attr\">recovery:</span>\n      <span class=\"hljs-attr\">recovery-enabled:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">update-job-forcibly:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">quartz-clustered:</span> <span class=\"hljs-literal\">false</span>\n      <span class=\"hljs-attr\">recover-duration:</span> <span class=\"hljs-number\">30</span>\n      <span class=\"hljs-attr\">max-retry-count:</span> <span class=\"hljs-number\">3</span>\n      <span class=\"hljs-attr\">fetch-page-size:</span> <span class=\"hljs-number\">200</span>\n      <span class=\"hljs-attr\">cron-expression:</span> <span class=\"hljs-string\">\"0/30 * * * * ? \"</span>\n</code></pre>\n<p>application-server.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\">#server模式额外配置</span>\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">remoting</span>\n      <span class=\"hljs-attr\">domain:</span> <span class=\"hljs-string\">\"AGG:TEST:CLIENT:\"</span>\n      <span class=\"hljs-attr\">serializer-type:</span> <span class=\"hljs-string\">kryo</span>\n      <span class=\"hljs-attr\">request-timeout-millis:</span> <span class=\"hljs-number\">10000</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">cluster-name:</span> <span class=\"hljs-string\">default</span>\n      <span class=\"hljs-attr\">registry-type:</span> <span class=\"hljs-string\">direct</span>\n      <span class=\"hljs-attr\">direct:</span>\n        <span class=\"hljs-attr\">addresses-for-client:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:2332</span>\n\n\n</code></pre>\n<p>在resources目录下，添加h2数据库初始化脚本\nschema.sql</p>\n<pre><code class=\"language-sql\"><span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`ACCOUNT`</span>;\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`ACCOUNT`</span>\n(\n    <span class=\"hljs-string\">`ID`</span> <span class=\"hljs-built_in\">bigint</span>(<span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,\n    <span class=\"hljs-string\">`ACCOUNT_ID`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">40</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'账户id'</span>,\n    <span class=\"hljs-string\">`EVENT_STATUS`</span> <span class=\"hljs-built_in\">bigint</span>(<span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'状态(测试agg事件)'</span>,\n    <span class=\"hljs-string\">`CREATE_TIME`</span> datetime <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CURRENT_TIMESTAMP</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'创建时间'</span>,\n    <span class=\"hljs-string\">`LAST_UPDATE_TIME`</span> datetime <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CURRENT_TIMESTAMP</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'最近更新时间'</span>,\n    <span class=\"hljs-string\">`VERSION`</span> <span class=\"hljs-built_in\">int</span>(<span class=\"hljs-number\">11</span>) <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-string\">'1'</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'版本号'</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`ID`</span>)\n);\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">INDEX</span> <span class=\"hljs-keyword\">ON</span> <span class=\"hljs-keyword\">ACCOUNT</span>(ACCOUNT_ID);\n\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`SUB_ACCOUNT`</span>;\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-string\">`SUB_ACCOUNT`</span>\n(\n    <span class=\"hljs-string\">`ID`</span> <span class=\"hljs-built_in\">bigint</span>(<span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> AUTO_INCREMENT,\n    <span class=\"hljs-string\">`ACCOUNT_ID`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">40</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'子账户id'</span>,\n    <span class=\"hljs-string\">`PARENT_ID`</span> <span class=\"hljs-built_in\">varchar</span>(<span class=\"hljs-number\">40</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'主账户主键'</span>,\n    <span class=\"hljs-string\">`EVENT_STATUS`</span> <span class=\"hljs-built_in\">bigint</span>(<span class=\"hljs-number\">20</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span> <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'状态(测试agg事件)'</span>,\n    <span class=\"hljs-string\">`CREATE_TIME`</span> datetime <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CURRENT_TIMESTAMP</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'创建时间'</span>,\n    <span class=\"hljs-string\">`LAST_UPDATE_TIME`</span> datetime <span class=\"hljs-keyword\">DEFAULT</span> <span class=\"hljs-keyword\">CURRENT_TIMESTAMP</span> <span class=\"hljs-keyword\">COMMENT</span> <span class=\"hljs-string\">'最近更新时间'</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (<span class=\"hljs-string\">`ID`</span>)\n);\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">UNIQUE</span> <span class=\"hljs-keyword\">INDEX</span> <span class=\"hljs-keyword\">ON</span> SUB_ACCOUNT(ACCOUNT_ID);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> <span class=\"hljs-keyword\">ON</span> SUB_ACCOUNT(PARENT_ID);\n</code></pre>\n<p>7.1 使用embedded模式<br>\n将application.yaml中的spring.profiles.active设为local<br>\n修改<strong>aggregate-framework-dashboard模块</strong>resource目录下的配置文件<br>\napplication.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/aggregate-framework-dashboard</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">22332</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-dashboard</span>\n  <span class=\"hljs-attr\">resources:</span>\n    <span class=\"hljs-attr\">static-locations:</span> <span class=\"hljs-string\">classpath:templates/</span>\n    <span class=\"hljs-attr\">chain:</span>\n      <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-literal\">false</span>\n  <span class=\"hljs-attr\">freemarker:</span>\n    <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-literal\">false</span>\n    <span class=\"hljs-attr\">charset:</span> <span class=\"hljs-string\">UTF-8</span>\n    <span class=\"hljs-attr\">suffix:</span> <span class=\"hljs-string\">.html</span>\n    <span class=\"hljs-attr\">check-template-location:</span> <span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-attr\">template-loader-path:</span> <span class=\"hljs-string\">classpath:/templates/</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">dashboard:</span>\n      <span class=\"hljs-attr\">userName:</span> <span class=\"hljs-string\">admin</span>\n      <span class=\"hljs-attr\">password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">connection-mode:</span> <span class=\"hljs-string\">embedded</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">registry-role:</span> <span class=\"hljs-string\">dashboard</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">redis</span>\n      <span class=\"hljs-attr\">redis:</span>\n        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">6379</span>\n        <span class=\"hljs-attr\">database:</span> <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-attr\">pool-config:</span>\n          <span class=\"hljs-attr\">max-total:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">max-idle:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">min-idle:</span> <span class=\"hljs-number\">10</span>\n          <span class=\"hljs-attr\">max-wait-millis:</span> <span class=\"hljs-number\">300</span>\n    \n</code></pre>\n<p>7.2 使用server模式<br>\n将application.yaml中的spring.profiles.active设为server<br>\n修改<strong>aggregate-framework-dashboard模块</strong>resource目录下的配置文件<br>\napplication.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-comment\"># dashbaord aggserver模式专项配置</span>\n<span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/aggregate-framework-dashboard</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">22332</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-dashboard</span>\n  <span class=\"hljs-attr\">resources:</span>\n    <span class=\"hljs-attr\">static-locations:</span> <span class=\"hljs-string\">classpath:templates/</span>\n    <span class=\"hljs-attr\">chain:</span>\n      <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-literal\">false</span>\n  <span class=\"hljs-attr\">freemarker:</span>\n    <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-attr\">cache:</span> <span class=\"hljs-literal\">false</span>\n    <span class=\"hljs-attr\">charset:</span> <span class=\"hljs-string\">UTF-8</span>\n    <span class=\"hljs-attr\">suffix:</span> <span class=\"hljs-string\">.html</span>\n    <span class=\"hljs-attr\">check-template-location:</span> <span class=\"hljs-literal\">true</span>\n    <span class=\"hljs-attr\">template-loader-path:</span> <span class=\"hljs-string\">classpath:/templates/</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">dashboard:</span>\n      <span class=\"hljs-attr\">userName:</span> <span class=\"hljs-string\">admin</span>\n      <span class=\"hljs-attr\">password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">connection-mode:</span> <span class=\"hljs-string\">server</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">registry-type:</span> <span class=\"hljs-string\">direct</span>\n      <span class=\"hljs-attr\">registry-role:</span> <span class=\"hljs-string\">dashboard</span>\n      <span class=\"hljs-attr\">direct:</span>\n        <span class=\"hljs-attr\">addresses-for-dashboard:</span> <span class=\"hljs-string\">localhost:12332</span>\n<span class=\"hljs-attr\">feign:</span>\n  <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/aggregate-framework-server</span>\n</code></pre>\n<p>修改<strong>aggregate-framework-server模块</strong>resource目录下的配置文件<br>\napplication.yaml</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">12332</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/${spring.application.name}</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-server</span>\n  <span class=\"hljs-attr\">autoconfigure:</span>\n    <span class=\"hljs-attr\">exclude:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">redis</span>\n      <span class=\"hljs-attr\">jdbc:</span>\n        <span class=\"hljs-attr\">password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">redis:</span>\n        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">6379</span>\n        <span class=\"hljs-attr\">database:</span> <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-attr\">pool-config:</span>\n          <span class=\"hljs-attr\">max-total:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">max-idle:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">min-idle:</span> <span class=\"hljs-number\">10</span>\n          <span class=\"hljs-attr\">max-wait-millis:</span> <span class=\"hljs-number\">300</span>\n    <span class=\"hljs-attr\">recovery:</span>\n      <span class=\"hljs-attr\">quartz-clustered:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">quartz-data-source-url:</span> <span class=\"hljs-string\">jdbc:mysql://localhost:3306/AGG_SERVER?useSSL=false&amp;allowPublicKeyRetrieval=true</span>\n      <span class=\"hljs-attr\">quartz-data-source-driver:</span> <span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n      <span class=\"hljs-attr\">quartz-data-source-user:</span> <span class=\"hljs-string\">root</span>\n      <span class=\"hljs-attr\">quartz-data-source-password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">max-retry-count:</span> <span class=\"hljs-number\">3</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">registry-type:</span> <span class=\"hljs-string\">direct</span>\n      <span class=\"hljs-attr\">cluster-name:</span> <span class=\"hljs-string\">default</span>\n    <span class=\"hljs-attr\">remoting:</span>\n      <span class=\"hljs-attr\">listen-port:</span> <span class=\"hljs-number\">2332</span>\n</code></pre>\n<h2 id=\"%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA\">功能演示 <a class=\"header-anchor\" href=\"#%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA\">#</a></h2>\n<p>至此，准备工作已就绪，在示例中采用了redis来保存事务日志，因此需要在本地启动redis服务。此外，若采用server模式还需要在本地启动mysql服务，并执行以下脚本，用于<a href=\"https://github.com/quartz-scheduler/quartz\">quartz框架</a></p>\n<pre><code class=\"language-sql\"><span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">DATABASE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-keyword\">EXISTS</span> <span class=\"hljs-string\">`AGG_SERVER`</span> <span class=\"hljs-built_in\">CHARACTER</span> <span class=\"hljs-keyword\">SET</span> <span class=\"hljs-string\">'utf8mb4'</span> <span class=\"hljs-keyword\">COLLATE</span> <span class=\"hljs-string\">'utf8mb4_unicode_ci'</span>;\n\n<span class=\"hljs-keyword\">USE</span> <span class=\"hljs-string\">`AGG_SERVER`</span>;\n\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_FIRED_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_PAUSED_TRIGGER_GRPS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_SCHEDULER_STATE;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_LOCKS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_SIMPLE_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_SIMPROP_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_CRON_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_BLOB_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_TRIGGERS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_JOB_DETAILS;\n<span class=\"hljs-keyword\">DROP</span> <span class=\"hljs-keyword\">TABLE</span> <span class=\"hljs-keyword\">IF</span> <span class=\"hljs-keyword\">EXISTS</span> QRTZ_CALENDARS;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_JOB_DETAILS\n(\n    SCHED_NAME        <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_NAME          <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_GROUP         <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    DESCRIPTION       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">250</span>) <span class=\"hljs-literal\">NULL</span>,\n    JOB_CLASS_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">250</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    IS_DURABLE        <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    IS_NONCONCURRENT  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    IS_UPDATE_DATA    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    REQUESTS_RECOVERY <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_DATA          <span class=\"hljs-built_in\">BLOB</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, JOB_NAME, JOB_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_TRIGGERS\n(\n    SCHED_NAME     <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_NAME       <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_GROUP      <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    DESCRIPTION    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">250</span>) <span class=\"hljs-literal\">NULL</span>,\n    NEXT_FIRE_TIME <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-literal\">NULL</span>,\n    PREV_FIRE_TIME <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-literal\">NULL</span>,\n    <span class=\"hljs-keyword\">PRIORITY</span>       <span class=\"hljs-built_in\">INTEGER</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_STATE  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">16</span>)  <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_TYPE   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">8</span>)   <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    START_TIME     <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    END_TIME       <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-literal\">NULL</span>,\n    CALENDAR_NAME  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-literal\">NULL</span>,\n    MISFIRE_INSTR  <span class=\"hljs-built_in\">SMALLINT</span>(<span class=\"hljs-number\">2</span>) <span class=\"hljs-literal\">NULL</span>,\n    JOB_DATA       <span class=\"hljs-built_in\">BLOB</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">FOREIGN</span> <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, JOB_NAME, JOB_GROUP)\n        <span class=\"hljs-keyword\">REFERENCES</span> QRTZ_JOB_DETAILS (SCHED_NAME, JOB_NAME, JOB_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_SIMPLE_TRIGGERS\n(\n    SCHED_NAME      <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    REPEAT_COUNT    <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">7</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    REPEAT_INTERVAL <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">12</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TIMES_TRIGGERED <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">10</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">FOREIGN</span> <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n        <span class=\"hljs-keyword\">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_CRON_TRIGGERS\n(\n    SCHED_NAME      <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    CRON_EXPRESSION <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TIME_ZONE_ID    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">80</span>),\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">FOREIGN</span> <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n        <span class=\"hljs-keyword\">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_SIMPROP_TRIGGERS\n(\n    SCHED_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    STR_PROP_1    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">512</span>) <span class=\"hljs-literal\">NULL</span>,\n    STR_PROP_2    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">512</span>) <span class=\"hljs-literal\">NULL</span>,\n    STR_PROP_3    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">512</span>) <span class=\"hljs-literal\">NULL</span>,\n    INT_PROP_1    <span class=\"hljs-built_in\">INT</span> <span class=\"hljs-literal\">NULL</span>,\n    INT_PROP_2    <span class=\"hljs-built_in\">INT</span> <span class=\"hljs-literal\">NULL</span>,\n    LONG_PROP_1   <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-literal\">NULL</span>,\n    LONG_PROP_2   <span class=\"hljs-built_in\">BIGINT</span> <span class=\"hljs-literal\">NULL</span>,\n    DEC_PROP_1    <span class=\"hljs-built_in\">NUMERIC</span>(<span class=\"hljs-number\">13</span>, <span class=\"hljs-number\">4</span>) <span class=\"hljs-literal\">NULL</span>,\n    DEC_PROP_2    <span class=\"hljs-built_in\">NUMERIC</span>(<span class=\"hljs-number\">13</span>, <span class=\"hljs-number\">4</span>) <span class=\"hljs-literal\">NULL</span>,\n    BOOL_PROP_1   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>) <span class=\"hljs-literal\">NULL</span>,\n    BOOL_PROP_2   <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>) <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">FOREIGN</span> <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n        <span class=\"hljs-keyword\">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_BLOB_TRIGGERS\n(\n    SCHED_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    BLOB_DATA     <span class=\"hljs-built_in\">BLOB</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">INDEX</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),\n    <span class=\"hljs-keyword\">FOREIGN</span> <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n        <span class=\"hljs-keyword\">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_CALENDARS\n(\n    SCHED_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    CALENDAR_NAME <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    CALENDAR      <span class=\"hljs-built_in\">BLOB</span>         <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, CALENDAR_NAME)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_PAUSED_TRIGGER_GRPS\n(\n    SCHED_NAME    <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, TRIGGER_GROUP)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_FIRED_TRIGGERS\n(\n    SCHED_NAME        <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    ENTRY_ID          <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">95</span>)  <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_NAME      <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    TRIGGER_GROUP     <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    INSTANCE_NAME     <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    FIRED_TIME        <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    SCHED_TIME        <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    <span class=\"hljs-keyword\">PRIORITY</span>          <span class=\"hljs-built_in\">INTEGER</span>      <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    STATE             <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">16</span>)  <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    JOB_NAME          <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-literal\">NULL</span>,\n    JOB_GROUP         <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-literal\">NULL</span>,\n    IS_NONCONCURRENT  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>) <span class=\"hljs-literal\">NULL</span>,\n    REQUESTS_RECOVERY <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">1</span>) <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, ENTRY_ID)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_SCHEDULER_STATE\n(\n    SCHED_NAME        <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    INSTANCE_NAME     <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">190</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    LAST_CHECKIN_TIME <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    CHECKIN_INTERVAL  <span class=\"hljs-built_in\">BIGINT</span>(<span class=\"hljs-number\">13</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, INSTANCE_NAME)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">TABLE</span> QRTZ_LOCKS\n(\n    SCHED_NAME <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">120</span>) <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    LOCK_NAME  <span class=\"hljs-built_in\">VARCHAR</span>(<span class=\"hljs-number\">40</span>)  <span class=\"hljs-keyword\">NOT</span> <span class=\"hljs-literal\">NULL</span>,\n    PRIMARY <span class=\"hljs-keyword\">KEY</span> (SCHED_NAME, LOCK_NAME)\n) <span class=\"hljs-keyword\">ENGINE</span>=<span class=\"hljs-keyword\">InnoDB</span>;\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_J_REQ_RECOVERY <span class=\"hljs-keyword\">ON</span> QRTZ_JOB_DETAILS (SCHED_NAME, REQUESTS_RECOVERY);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_J_GRP <span class=\"hljs-keyword\">ON</span> QRTZ_JOB_DETAILS (SCHED_NAME, JOB_GROUP);\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_J <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, JOB_NAME, JOB_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_JG <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, JOB_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_C <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, CALENDAR_NAME);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_G <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_STATE <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_STATE);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_N_STATE <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP, TRIGGER_STATE);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_N_G_STATE <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_GROUP, TRIGGER_STATE);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_NEXT_FIRE_TIME <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, NEXT_FIRE_TIME);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_NFT_ST <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_STATE, NEXT_FIRE_TIME);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_NFT_MISFIRE <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME, TRIGGER_STATE);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE_GRP <span class=\"hljs-keyword\">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME, TRIGGER_GROUP,\n                                                             TRIGGER_STATE);\n\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_TRIG_INST_NAME <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, INSTANCE_NAME);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_INST_JOB_REQ_RCVRY <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, INSTANCE_NAME, REQUESTS_RECOVERY);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_J_G <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, JOB_NAME, JOB_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_JG <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, JOB_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_T_G <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP);\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">INDEX</span> IDX_QRTZ_FT_TG <span class=\"hljs-keyword\">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, TRIGGER_GROUP);\n\n<span class=\"hljs-keyword\">commit</span>;\n</code></pre>\n<p>接下来可依次运行server服务(如若需要)、dashboard服务和示例项目。server服务和dashboard服务可以通过下载<a href=\"https://github.com/changmingxie/aggregate-framework\">AGG源码</a>编译运行。也可直接在本地部署相应jar包，详见<a href=\"/zh-cn/aggdocs/ops/server/index.html\">server部署</a>和<a href=\"/zh-cn/aggdocs/ops/dashboard/index.html\">dashboard部署</a>。<br>\n项目正常运行后，可通过访问<a href=\"http://localhost:22332/aggregate-framework-dashboard\">http://localhost:22332/aggregate-framework-dashboard</a>，进入管理后台。用户名密码分别为admin和123456。<br>\n<img src=\"../img/dashboard_index.png\" alt=\"管理后台首页\">\n在Domain管理一栏中可以看到示例项目的domain信息，配置事件堆积处理、告警策略。\n<img src=\"../img/dashboard_domin.png\" alt=\"管理后台-Domain管理\">\n在事件管理一栏中可以，选中当前domain，即可处理该domain下堆积的事件，显然此时并没有。\n<img src=\"../img/dashboard_event1.png\" alt=\"管理后台-事件管理1\">\n在任务管理一栏中可以，可以启停或调整事件恢复任务的执行频率，需要注意的是该功能目前只支持<strong>server模式</strong>。\n<img src=\"../img/dashboard_task.png\" alt=\"管理后台-任务管理\">\n有关管理后台的详细介绍，可查看<a href=\"/zh-cn/aggdocs/ops/dashboard/dashboard-guild.html\">dashboard使用手册</a>。<br>\n<br/>\n尝试调用创建账户的api <a href=\"http://localhost:8080/aggregate-framework-basic-usage/account/create\">http://localhost:8080/aggregate-framework-basic-usage/account/create</a>，页面的返回值为accountId。<br>\n<img src=\"../img/democase1.png\" alt=\"示例图1\">\n然后立刻调用账户查询的api<a href=\"http://localhost:8080/aggregate-framework-basic-usage/account/query?accountId=***\">http://localhost:8080/aggregate-framework-basic-usage/account/query?accountId=***</a>(使用先前返回的accountId来替换***)，页面的返回值即为先前创建的账户信息。账户信息的状态有一定概率不为3。<br>\n<img src=\"../img/democase2.png\" alt=\"示例图2\">\n查询管理后台事件管理一栏，可以观察到发生了事件堆积，且项目日志中打印了乐观锁异常。这是由于示例项目中故意使用了两个事件处理器来同时修改账户的状态，从而造成了并发冲突。\n<img src=\"../img/democase3.png\" alt=\"示例图3\">\n<img src=\"../img/democase4.png\" alt=\"示例图4\">\n等待30-60秒后再次观察可以发现堆积的事件重试成功，账户信息的状态被修改成3，从而达到最终一致性。<br>\n<img src=\"../img/democase5.png\" alt=\"示例图5\">\n<img src=\"../img/democase6.png\" alt=\"示例图6\">\n<br/>\n也可访问<a href=\"http://localhost:8080/aggregate-framework-basic-usage/h2-console/login.jsp?jsessionid=943c595f39ca676919021daba287aa8a\">H2管理后台</a>直接查看数据库中的记录，做进一步观察。(JDBC URL为 jdbc:h2:mem:AGG_TEST，用户名为root，密码为welcome1)<br>\n<img src=\"../img/democase7.png\" alt=\"示例图7\"></p>\n<h2 id=\"%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE\">示例项目 <a class=\"header-anchor\" href=\"#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE\">#</a></h2>\n<p>恭喜你完成了该教程，完整的项目代码可在此获取<a href=\"https://github.com/changmingxie/aggregate-framework/tree/master-4.x/aggregate-framework-tutorial-sample/aggregate-framework-basic-usage\">aggregate-framework-basic-usage</a></p>\n",
  "link": "/zh-cn/aggdocs/tutorial/quickstart.html",
  "meta": {}
}