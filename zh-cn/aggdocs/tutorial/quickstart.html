<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="quickstart" />
	<meta name="description" content="quickstart" />
	<!-- 网页标签标题 -->
	<title>quickstart</title>
	<link rel="shortcut icon" href="/img/tcc_logo.png"/>
	<link rel="stylesheet" href="/build/aggDocumentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/tcc_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><span><a href="/zh-cn/index.html" target="_self">首页</a></span></li><li class="menu-item menu-item-normal"><div class="nav-container"><div class="word"><a>文档</a></div><ul class="sub-nav-container" style="width:220px"><li><a href="/zh-cn/docs/what-is-tcctransaction.html" target="_self">TCC文档</a></li><li><a href="/zh-cn/aggdocs/what-is-aggregateframework.html" target="_self">AGG文档</a></li></ul></div></li><li class="menu-item menu-item-normal"><span><a href="/zh-cn/blog/index.html" target="_self">博客</a></span></li><li class="menu-item menu-item-normal"><span><a href="/zh-cn/community/index.html" target="_self">社区</a></span></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>AGG文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>概述</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/what-is-aggregateframework.html" target="_self">AGGREGATE-FRAMEWORK是什么</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/terminology.html" target="_self">术语</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/faq.html" target="_self">FAQ</a></li></ul></li><li class="menu-item menu-item-level-1"><span>用户指南</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/tutorial/quickstart.html" target="_self">快速开始</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/tutorial/configurations.html" target="_self">参数配置</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/tutorial/api.html" target="_self">API支持</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/tutorial/eventhandler.html" target="_self">事件处理器</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>连接模式<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/connectionmode/embedded.html" target="_self">embedded模式</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/connectionmode/server.html" target="_self">server模式</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>存储类型<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/memory.html" target="_self">memory</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/rocksdb.html" target="_self">rocksdb</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/jdbc.html" target="_self">jdbc</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/redis.html" target="_self">redis</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/shard-redis.html" target="_self">shard-redis</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/redis-cluster.html" target="_self">redis-cluster</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/remoting.html" target="_self">remoting</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/storagetype/custom.html" target="_self">custom</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>事件序列化<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/serializer/index.html" target="_self">说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/serializer/kryo.html" target="_self">kryo</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/serializer/fastjson.html" target="_self">fastjson</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/serializer/custom.html" target="_self">custom</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>注册中心支持<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/registry/index.html" target="_self">说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/registry/direct.html" target="_self">direct</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/registry/nacos.html" target="_self">nacos</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/registry/zookeeper.html" target="_self">zookeeper</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/tutorial/registry/custom.html" target="_self">custom</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>运维指南</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/ops/upgrade.html" target="_self">版本升级指南</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>server部署<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/ops/server/index.html" target="_self">部署说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/ops/server/deploy.html" target="_self">部署示例</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>dashboard部署<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/ops/dashboard/index.html" target="_self">部署说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/aggdocs/ops/dashboard/deploy.html" target="_self">部署示例</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/aggdocs/ops/dashboard/dashboard-guild.html" target="_self">dashboard使用手册</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1 id="%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">快速开始 <a class="header-anchor" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">#</a></h1>
<p>让我们从一个简单的示例开始！</p>
<h2 id="%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E">示例说明 <a class="header-anchor" href="#%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E">#</a></h2>
<p>在该示例中，我们将账户(Account)作为<strong>聚合根</strong>，子账户(SubAccount)作为<strong>领域对象</strong>，一个账户下可以存在若干个子账户。在为用户创建账户时，会借助<strong>事件</strong>来对账户进行初始化。</p>
<h2 id="%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4">搭建步骤 <a class="header-anchor" href="#%E6%90%AD%E5%BB%BA%E6%AD%A5%E9%AA%A4">#</a></h2>
<p>1.新建一个springboot项目，添加maven依赖</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!--需要先在本地install aggregate-framework项目--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aggregateframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aggregate-framework-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.13.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.197<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.13.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>19.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>2.以org.aggregateframework.basic.usage为根目录，在根目录下新建启动类<br>
BasicUsageApplication.java</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage;

<span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan</span>(<span class="hljs-string">"org.aggregateframework.basic.usage.dao"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicUsageApplication</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        SpringApplication.run(BasicUsageApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;
    }
}
</code></pre>
<p>3.新建entity目录，创建Account和SubAccount对象<br>
Account.java</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.entity;

<span class="hljs-keyword">import</span> lombok.*;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.event.AccountCreateEvent;
<span class="hljs-keyword">import</span> org.aggregateframework.entity.AbstractSimpleAggregateRoot;
<span class="hljs-keyword">import</span> org.aggregateframework.entity.DaoAwareQuery;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * Account类继承自AbstractSimpleAggregateRoot，代表它是一个聚合根。
 * 使用<span class="hljs-doctag">@DaoAwareQuery</span>来表示在查找Account时，如何获取其关联的领域对象
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@EqualsAndHashCode</span>(callSuper = <span class="hljs-keyword">true</span>)
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Account</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSimpleAggregateRoot</span>&lt;<span class="hljs-title">Long</span>&gt; </span>{

    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String accountId;

    <span class="hljs-keyword">private</span> Integer eventStatus;

    <span class="hljs-meta">@DaoAwareQuery</span>(mappedBy = <span class="hljs-string">"account"</span>, select = <span class="hljs-string">"findByParentId"</span>)
    <span class="hljs-keyword">private</span> List&lt;SubAccount&gt; subAccounts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyAccountCreateEvent</span><span class="hljs-params">()</span></span>{
        apply(<span class="hljs-keyword">new</span> AccountCreateEvent(accountId));
    }
}

</code></pre>
<p>SubAccount.java</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.entity;

<span class="hljs-keyword">import</span> lombok.*;
<span class="hljs-keyword">import</span> org.aggregateframework.entity.AbstractSimpleDomainObject;

<span class="hljs-comment">/**
 * SubAccount类继承自AbstractSimpleAggregateRoot，代表它是一个领域对象。
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@EqualsAndHashCode</span>(callSuper = <span class="hljs-keyword">true</span>)
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SubAccount</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSimpleDomainObject</span>&lt;<span class="hljs-title">Long</span>&gt; </span>{

    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String accountId;

    <span class="hljs-keyword">private</span> Account account;

    <span class="hljs-keyword">private</span> Integer eventStatus;
}
</code></pre>
<p>4.添加仓储层代码<br>
新建dao目录，创建AccountDao和SubAccountDao对象<br>
AccountDao.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.dao;

<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.Account;
<span class="hljs-keyword">import</span> org.aggregateframework.dao.AggregateRootDao;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AccountDao</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AggregateRootDao</span>&lt;<span class="hljs-title">Account</span>,<span class="hljs-title">Long</span>&gt; </span>{

    <span class="hljs-function">Account <span class="hljs-title">findByAccountId</span><span class="hljs-params">(@Param(<span class="hljs-string">"accountId"</span>)</span> String accountId)</span>;

    <span class="hljs-function">List&lt;Account&gt; <span class="hljs-title">findByAccountIds</span><span class="hljs-params">(List&lt;String&gt; accountIds)</span></span>;
}
</code></pre>
<p>SubAccountDao.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.dao;

<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.SubAccount;
<span class="hljs-keyword">import</span> org.aggregateframework.dao.DomainObjectDao;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Param;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SubAccountDao</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DomainObjectDao</span>&lt;<span class="hljs-title">SubAccount</span>,<span class="hljs-title">Long</span>&gt; </span>{

    <span class="hljs-function">List&lt;SubAccount&gt; <span class="hljs-title">findByParentId</span><span class="hljs-params">(@Param(<span class="hljs-string">"parentId"</span>)</span> Long parentId)</span>;
}
</code></pre>
<p>在resources目录下新建mapping目录，添加对应的XML文件<br>
AccountMapper.xml</p>
<pre><code class="language-xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.dao.AccountDao"</span> &gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"baseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.Account"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"ID"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"accountId"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"ACCOUNT_ID"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"eventStatus"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"EVENT_STATUS"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"CREATE_TIME"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"lastUpdateTime"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"LAST_UPDATE_TIME"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"version"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"VERSION"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sql_select"</span>&gt;</span>
        SELECT ID,
               ACCOUNT_ID,
               EVENT_STATUS,
               VERSION,
               CREATE_TIME,
               LAST_UPDATE_TIME
        FROM ACCOUNT
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findAll"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
		WHERE ID=#{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findByAccountId"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
        WHERE ACCOUNT_ID=#{accountId}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findByAccountIds"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
        WHERE ACCOUNT_ID in 
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span>
            #{item}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">keyColumn</span>=<span class="hljs-string">"ID"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.Account"</span>&gt;</span>
        INSERT INTO ACCOUNT
            (ACCOUNT_ID,EVENT_STATUS,VERSION,CREATE_TIME,LAST_UPDATE_TIME)
        VALUES
            (#{accountId},#{eventStatus},#{version},#{createTime},#{lastUpdateTime})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"update"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.Account"</span>&gt;</span>
        UPDATE
        `ACCOUNT`
        SET
        ACCOUNT_ID=#{accountId},
        EVENT_STATUS=#{eventStatus},
        VERSION=#{version},
        LAST_UPDATE_TIME=#{lastUpdateTime}
        WHERE ID=#{id}
        AND VERSION=#{version}-1
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"delete"</span>&gt;</span>
        DELETE FROM ACCOUNT WHERE ID=#{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<p>SubAccountMapper.xml</p>
<pre><code class="language-xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.dao.SubAccountDao"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"baseResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.SubAccount"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"ID"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"accountId"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"ACCOUNT_ID"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"account.id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"PARENT_ID"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"eventStatus"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"EVENT_STATUS"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"createTime"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"CREATE_TIME"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"lastUpdateTime"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"LAST_UPDATE_TIME"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sql_select"</span>&gt;</span>
        SELECT ID,
               ACCOUNT_ID,
               PARENT_ID,
               EVENT_STATUS,
               CREATE_TIME,
               LAST_UPDATE_TIME
        FROM SUB_ACCOUNT
    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
        WHERE ID=#{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findByParentId"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"baseResultMap"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">"sql_select"</span>/&gt;</span>
        WHERE PARENT_ID = #{parentId}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">keyColumn</span>=<span class="hljs-string">"ID"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.SubAccount"</span>&gt;</span>
        INSERT INTO SUB_ACCOUNT
            (ACCOUNT_ID,PARENT_ID,EVENT_STATUS,CREATE_TIME,LAST_UPDATE_TIME)
        VALUES
        (#{accountId},#{account.id},#{eventStatus},#{createTime},#{lastUpdateTime})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"update"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"org.aggregateframework.basic.usage.entity.SubAccount"</span>&gt;</span>
        UPDATE
            `SUB_ACCOUNT`
        SET
            ACCOUNT_ID=#{accountId},
            PARENT_ID=#{account.id},
            EVENT_STATUS=#{eventStatus},
            LAST_UPDATE_TIME=#{lastUpdateTime}
        WHERE ID=#{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"delete"</span>&gt;</span>
        DELETE FROM
            SUB_ACCOUNT WHERE ID=#{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<p>新建repository目录，为聚合根添加Repository<br>
AccountRepository.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.repository;


<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.dao.AccountDao;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.Account;
<span class="hljs-keyword">import</span> org.aggregateframework.repository.DaoAwareAggregateRepository;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DaoAwareAggregateRepository</span>&lt;<span class="hljs-title">Account</span>,<span class="hljs-title">Long</span>&gt; </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountDao accountDao;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AccountRepository</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">super</span>(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Account <span class="hljs-title">findByAccountId</span><span class="hljs-params">(String accountId)</span> </span>{
        <span class="hljs-keyword">return</span> fetchAllComponents(accountDao.findByAccountId(accountId));
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Account&gt; <span class="hljs-title">findByAccountIds</span><span class="hljs-params">(List&lt;String&gt; accountIds)</span> </span>{
        <span class="hljs-keyword">return</span> fetchAllComponents(accountDao.findByAccountIds(accountIds));
    }
}

</code></pre>
<p>5.新建event目录，添加事件和事件处理器
AccountCreateEvent.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.event;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountCreateEvent</span> </span>{

    <span class="hljs-keyword">private</span> String accountId;
}
</code></pre>
<p>AccountEventHandler.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.event;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.Account;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.repository.AccountRepository;
<span class="hljs-keyword">import</span> org.aggregateframework.eventhandling.annotation.AsyncConfig;
<span class="hljs-keyword">import</span> org.aggregateframework.eventhandling.annotation.EventHandler;
<span class="hljs-keyword">import</span> org.aggregateframework.eventhandling.annotation.QueueFullPolicy;
<span class="hljs-keyword">import</span> org.aggregateframework.eventhandling.annotation.TransactionCheck;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-comment">/**
 * 使用<span class="hljs-doctag">@EventHandler</span>创建事件处理器，此处通过修改账户的状态位来模拟对账户的初始化操作。
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountEventHandler</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountRepository accountRepository;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer AGG_EVENT_STATUS_POS_1 = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer AGG_EVENT_STATUS_POS_2 = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>;

    <span class="hljs-meta">@EventHandler</span>(asynchronous = <span class="hljs-keyword">true</span>, postAfterTransaction = <span class="hljs-keyword">true</span>, isTransactionMessage = <span class="hljs-keyword">true</span>,
            asyncConfig = <span class="hljs-meta">@AsyncConfig</span>(queueFullPolicy = QueueFullPolicy.DISCARD),
            transactionCheck = <span class="hljs-meta">@TransactionCheck</span>(checkTransactionStatusMethod = <span class="hljs-string">"checkAccountCreateEvent"</span>))
    <span class="hljs-meta">@Transactional</span>(rollbackFor = Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>)
    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">handleAccountCreateEvent</span>(<span class="hljs-title">AccountCreateEvent</span> <span class="hljs-title">accountCreateEvent</span>) </span>{
        log.info(<span class="hljs-string">"exec handleAccountCreateEvent，{}"</span>, accountCreateEvent);
        Account account = accountRepository.findByAccountId(accountCreateEvent.getAccountId());
        <span class="hljs-keyword">if</span> (account != <span class="hljs-keyword">null</span>) {
            account.setEventStatus(account.getEventStatus() | AGG_EVENT_STATUS_POS_1);
            account.getSubAccounts().forEach(each -&gt; each.setEventStatus(each.getEventStatus() | AGG_EVENT_STATUS_POS_1));
        }
        accountRepository.save(account);
    }

    <span class="hljs-meta">@EventHandler</span>(asynchronous = <span class="hljs-keyword">true</span>, postAfterTransaction = <span class="hljs-keyword">true</span>, isTransactionMessage = <span class="hljs-keyword">true</span>,
            asyncConfig = <span class="hljs-meta">@AsyncConfig</span>(queueFullPolicy = QueueFullPolicy.DISCARD),
            transactionCheck = <span class="hljs-meta">@TransactionCheck</span>(checkTransactionStatusMethod = <span class="hljs-string">"batchCheckAccountCreateEvent"</span>))
    <span class="hljs-meta">@Transactional</span>(rollbackFor = Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>)
    <span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">batchHandleAccountCreateEvent</span>(<span class="hljs-title">List</span>&lt;<span class="hljs-title">AccountCreateEvent</span>&gt; <span class="hljs-title">accountCreateEvents</span>) </span>{
        log.info(<span class="hljs-string">"exec batchHandleAccountCreateEvent，{}"</span>, accountCreateEvents);
        List&lt;Account&gt; accounts = accountRepository.findByAccountIds(accountCreateEvents.stream().map(AccountCreateEvent::getAccountId).collect(Collectors.toList()));
        accounts.forEach(account -&gt; {
            account.setEventStatus(account.getEventStatus() | AGG_EVENT_STATUS_POS_2);
            account.getSubAccounts().forEach(each -&gt; each.setEventStatus(each.getEventStatus() | AGG_EVENT_STATUS_POS_2));
        });
        accountRepository.save(accounts);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkAccountCreateEvent</span><span class="hljs-params">(AccountCreateEvent accountCreateEvent)</span> </span>{
        <span class="hljs-keyword">return</span> accountRepository.findByAccountId(accountCreateEvent.getAccountId()) != <span class="hljs-keyword">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">batchCheckAccountCreateEvent</span><span class="hljs-params">(List&lt;AccountCreateEvent&gt; accountCreateEvents)</span> </span>{
        <span class="hljs-keyword">return</span> !accountRepository.findByAccountIds(accountCreateEvents.stream().map(AccountCreateEvent::getAccountId).collect(Collectors.toList())).isEmpty();
    }
}
</code></pre>
<p>6.新建controller目录，添加供外部创建账户的api<br>
AccountController.class</p>
<pre><code class="language-java"><span class="hljs-keyword">package</span> org.aggregateframework.basic.usage.controller;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.Account;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.entity.SubAccount;
<span class="hljs-keyword">import</span> org.aggregateframework.basic.usage.repository.AccountRepository;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.UUID;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;
<span class="hljs-keyword">import</span> java.util.stream.IntStream;

<span class="hljs-meta">@Slf</span>4j
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/account"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountController</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountRepository accountRepository;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/create"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">create</span><span class="hljs-params">(@RequestParam(defaultValue = <span class="hljs-string">"1"</span>)</span> Integer amount) </span>{
        String accountId = UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        Account account = Account.builder()
                .accountId(accountId)
                .eventStatus(<span class="hljs-number">0</span>)
                .build();
        List&lt;SubAccount&gt; subAccounts = IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>).mapToObj(each -&gt; SubAccount.builder()
                .accountId(accountId + <span class="hljs-string">"-"</span> + each)
                .account(account)
                .eventStatus(<span class="hljs-number">0</span>)
                .build()).collect(Collectors.toList());
        account.setSubAccounts(subAccounts);
        account.applyAccountCreateEvent();
        accountRepository.save(account);
        <span class="hljs-keyword">return</span> accountId;
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/query"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">query</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"accountId"</span>)</span> String accountId)</span>{
        <span class="hljs-keyword">return</span> JSON.toJSONString(accountRepository.findByAccountId(accountId));
    }
}
</code></pre>
<p>7.部署配置<br>
在resources目录下，添加项目配置文件<br>
application.yaml</p>
<pre><code class="language-yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/${spring.application.name}</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">aggregate-framework-basic-usage</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">local</span>  <span class="hljs-comment"># Possible values: local, server</span>
  <span class="hljs-comment">#使用h2数据库，存储业务数据</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.h2.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:h2:mem:AGG_TEST</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">welcome1</span>
    <span class="hljs-attr">initialization-mode:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">schema:</span> <span class="hljs-string">classpath:schema.sql</span>
  <span class="hljs-comment">#h2数据库控台地址 http://localhost:8080/aggregate-framework-basic-usage/h2-console</span>
  <span class="hljs-attr">h2:</span>
    <span class="hljs-attr">console:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">settings:</span>
        <span class="hljs-attr">web-allow-others:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapping/*.xml</span>

<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">info</span>
</code></pre>
<p>application-local.yaml</p>
<pre><code class="language-yaml"><span class="hljs-comment">#embedded模式额外配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">agg:</span>
    <span class="hljs-attr">storage:</span>
      <span class="hljs-attr">storage-type:</span> <span class="hljs-string">redis</span>
      <span class="hljs-attr">domain:</span> <span class="hljs-string">"AGG:TEST:CLIENT:"</span>
      <span class="hljs-attr">serializer-type:</span> <span class="hljs-string">kryo</span>
      <span class="hljs-attr">redis:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">pool-config:</span>
          <span class="hljs-attr">max-total:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">max-idle:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">min-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">max-wait-millis:</span> <span class="hljs-number">300</span>
    <span class="hljs-attr">recovery:</span>
      <span class="hljs-attr">recovery-enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">update-job-forcibly:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">quartz-clustered:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">recover-duration:</span> <span class="hljs-number">30</span>
      <span class="hljs-attr">max-retry-count:</span> <span class="hljs-number">3</span>
      <span class="hljs-attr">fetch-page-size:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">cron-expression:</span> <span class="hljs-string">"0/30 * * * * ? "</span>
</code></pre>
<p>application-server.yaml</p>
<pre><code class="language-yaml"><span class="hljs-comment">#server模式额外配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">agg:</span>
    <span class="hljs-attr">storage:</span>
      <span class="hljs-attr">storage-type:</span> <span class="hljs-string">remoting</span>
      <span class="hljs-attr">domain:</span> <span class="hljs-string">"AGG:TEST:CLIENT:"</span>
      <span class="hljs-attr">serializer-type:</span> <span class="hljs-string">kryo</span>
      <span class="hljs-attr">request-timeout-millis:</span> <span class="hljs-number">10000</span>
    <span class="hljs-attr">registry:</span>
      <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">default</span>
      <span class="hljs-attr">registry-type:</span> <span class="hljs-string">direct</span>
      <span class="hljs-attr">direct:</span>
        <span class="hljs-attr">addresses-for-client:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2332</span>


</code></pre>
<p>在resources目录下，添加h2数据库初始化脚本
schema.sql</p>
<pre><code class="language-sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`ACCOUNT`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`ACCOUNT`</span>
(
    <span class="hljs-string">`ID`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
    <span class="hljs-string">`ACCOUNT_ID`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'账户id'</span>,
    <span class="hljs-string">`EVENT_STATUS`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'状态(测试agg事件)'</span>,
    <span class="hljs-string">`CREATE_TIME`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'创建时间'</span>,
    <span class="hljs-string">`LAST_UPDATE_TIME`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'最近更新时间'</span>,
    <span class="hljs-string">`VERSION`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'版本号'</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`ID`</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">ACCOUNT</span>(ACCOUNT_ID);

<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`SUB_ACCOUNT`</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`SUB_ACCOUNT`</span>
(
    <span class="hljs-string">`ID`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT,
    <span class="hljs-string">`ACCOUNT_ID`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'子账户id'</span>,
    <span class="hljs-string">`PARENT_ID`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">40</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'主账户主键'</span>,
    <span class="hljs-string">`EVENT_STATUS`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'状态(测试agg事件)'</span>,
    <span class="hljs-string">`CREATE_TIME`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'创建时间'</span>,
    <span class="hljs-string">`LAST_UPDATE_TIME`</span> datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'最近更新时间'</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`ID`</span>)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> SUB_ACCOUNT(ACCOUNT_ID);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> SUB_ACCOUNT(PARENT_ID);
</code></pre>
<p>7.1 使用embedded模式<br>
将application.yaml中的spring.profiles.active设为local<br>
修改<strong>aggregate-framework-dashboard模块</strong>resource目录下的配置文件<br>
application.yaml</p>
<pre><code class="language-yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/aggregate-framework-dashboard</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22332</span>

<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">info</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">aggregate-framework-dashboard</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">static-locations:</span> <span class="hljs-string">classpath:templates/</span>
    <span class="hljs-attr">chain:</span>
      <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">freemarker:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span>
    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.html</span>
    <span class="hljs-attr">check-template-location:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates/</span>
  <span class="hljs-attr">agg:</span>
    <span class="hljs-attr">dashboard:</span>
      <span class="hljs-attr">userName:</span> <span class="hljs-string">admin</span>
      <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
      <span class="hljs-attr">connection-mode:</span> <span class="hljs-string">embedded</span>
    <span class="hljs-attr">registry:</span>
      <span class="hljs-attr">registry-role:</span> <span class="hljs-string">dashboard</span>
    <span class="hljs-attr">storage:</span>
      <span class="hljs-attr">storage-type:</span> <span class="hljs-string">redis</span>
      <span class="hljs-attr">redis:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">pool-config:</span>
          <span class="hljs-attr">max-total:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">max-idle:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">min-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">max-wait-millis:</span> <span class="hljs-number">300</span>
    
</code></pre>
<p>7.2 使用server模式<br>
将application.yaml中的spring.profiles.active设为server<br>
修改<strong>aggregate-framework-dashboard模块</strong>resource目录下的配置文件<br>
application.yaml</p>
<pre><code class="language-yaml"><span class="hljs-comment"># dashbaord aggserver模式专项配置</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/aggregate-framework-dashboard</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22332</span>

<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">info</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">aggregate-framework-dashboard</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">static-locations:</span> <span class="hljs-string">classpath:templates/</span>
    <span class="hljs-attr">chain:</span>
      <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">freemarker:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span>
    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.html</span>
    <span class="hljs-attr">check-template-location:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates/</span>
  <span class="hljs-attr">agg:</span>
    <span class="hljs-attr">dashboard:</span>
      <span class="hljs-attr">userName:</span> <span class="hljs-string">admin</span>
      <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
      <span class="hljs-attr">connection-mode:</span> <span class="hljs-string">server</span>
    <span class="hljs-attr">registry:</span>
      <span class="hljs-attr">registry-type:</span> <span class="hljs-string">direct</span>
      <span class="hljs-attr">registry-role:</span> <span class="hljs-string">dashboard</span>
      <span class="hljs-attr">direct:</span>
        <span class="hljs-attr">addresses-for-dashboard:</span> <span class="hljs-string">localhost:12332</span>
<span class="hljs-attr">feign:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">/aggregate-framework-server</span>
</code></pre>
<p>修改<strong>aggregate-framework-server模块</strong>resource目录下的配置文件<br>
application.yaml</p>
<pre><code class="language-yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">12332</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/${spring.application.name}</span>

<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">root:</span> <span class="hljs-string">info</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">aggregate-framework-server</span>
  <span class="hljs-attr">autoconfigure:</span>
    <span class="hljs-attr">exclude:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span>
  <span class="hljs-attr">agg:</span>
    <span class="hljs-attr">storage:</span>
      <span class="hljs-attr">storage-type:</span> <span class="hljs-string">redis</span>
      <span class="hljs-attr">jdbc:</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
      <span class="hljs-attr">redis:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
        <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">pool-config:</span>
          <span class="hljs-attr">max-total:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">max-idle:</span> <span class="hljs-number">100</span>
          <span class="hljs-attr">min-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">max-wait-millis:</span> <span class="hljs-number">300</span>
    <span class="hljs-attr">recovery:</span>
      <span class="hljs-attr">quartz-clustered:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">quartz-data-source-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/AGG_SERVER?useSSL=false&amp;allowPublicKeyRetrieval=true</span>
      <span class="hljs-attr">quartz-data-source-driver:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span>
      <span class="hljs-attr">quartz-data-source-user:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">quartz-data-source-password:</span> <span class="hljs-number">123456</span>
      <span class="hljs-attr">max-retry-count:</span> <span class="hljs-number">3</span>
    <span class="hljs-attr">registry:</span>
      <span class="hljs-attr">registry-type:</span> <span class="hljs-string">direct</span>
      <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">default</span>
    <span class="hljs-attr">remoting:</span>
      <span class="hljs-attr">listen-port:</span> <span class="hljs-number">2332</span>
</code></pre>
<h2 id="%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA">功能演示 <a class="header-anchor" href="#%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA">#</a></h2>
<p>至此，准备工作已就绪，在示例中采用了redis来保存事务日志，因此需要在本地启动redis服务。此外，若采用server模式还需要在本地启动mysql服务，并执行以下脚本，用于<a href="https://github.com/quartz-scheduler/quartz">quartz框架</a></p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> <span class="hljs-string">`AGG_SERVER`</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-string">'utf8mb4'</span> <span class="hljs-keyword">COLLATE</span> <span class="hljs-string">'utf8mb4_unicode_ci'</span>;

<span class="hljs-keyword">USE</span> <span class="hljs-string">`AGG_SERVER`</span>;

<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_FIRED_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_PAUSED_TRIGGER_GRPS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_SCHEDULER_STATE;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_LOCKS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_SIMPLE_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_SIMPROP_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_CRON_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_BLOB_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_TRIGGERS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_JOB_DETAILS;
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> QRTZ_CALENDARS;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_JOB_DETAILS
(
    SCHED_NAME        <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_NAME          <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_GROUP         <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    DESCRIPTION       <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">250</span>) <span class="hljs-literal">NULL</span>,
    JOB_CLASS_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">250</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    IS_DURABLE        <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    IS_NONCONCURRENT  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    IS_UPDATE_DATA    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    REQUESTS_RECOVERY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_DATA          <span class="hljs-built_in">BLOB</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, JOB_NAME, JOB_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_TRIGGERS
(
    SCHED_NAME     <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_NAME       <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_GROUP      <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    DESCRIPTION    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">250</span>) <span class="hljs-literal">NULL</span>,
    NEXT_FIRE_TIME <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-literal">NULL</span>,
    PREV_FIRE_TIME <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">PRIORITY</span>       <span class="hljs-built_in">INTEGER</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_STATE  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_TYPE   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">8</span>)   <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    START_TIME     <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    END_TIME       <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-literal">NULL</span>,
    CALENDAR_NAME  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-literal">NULL</span>,
    MISFIRE_INSTR  <span class="hljs-built_in">SMALLINT</span>(<span class="hljs-number">2</span>) <span class="hljs-literal">NULL</span>,
    JOB_DATA       <span class="hljs-built_in">BLOB</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (SCHED_NAME, JOB_NAME, JOB_GROUP)
        <span class="hljs-keyword">REFERENCES</span> QRTZ_JOB_DETAILS (SCHED_NAME, JOB_NAME, JOB_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_SIMPLE_TRIGGERS
(
    SCHED_NAME      <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    REPEAT_COUNT    <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">7</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    REPEAT_INTERVAL <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">12</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TIMES_TRIGGERED <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
        <span class="hljs-keyword">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_CRON_TRIGGERS
(
    SCHED_NAME      <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    CRON_EXPRESSION <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TIME_ZONE_ID    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">80</span>),
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
        <span class="hljs-keyword">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_SIMPROP_TRIGGERS
(
    SCHED_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    STR_PROP_1    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">512</span>) <span class="hljs-literal">NULL</span>,
    STR_PROP_2    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">512</span>) <span class="hljs-literal">NULL</span>,
    STR_PROP_3    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">512</span>) <span class="hljs-literal">NULL</span>,
    INT_PROP_1    <span class="hljs-built_in">INT</span> <span class="hljs-literal">NULL</span>,
    INT_PROP_2    <span class="hljs-built_in">INT</span> <span class="hljs-literal">NULL</span>,
    LONG_PROP_1   <span class="hljs-built_in">BIGINT</span> <span class="hljs-literal">NULL</span>,
    LONG_PROP_2   <span class="hljs-built_in">BIGINT</span> <span class="hljs-literal">NULL</span>,
    DEC_PROP_1    <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">13</span>, <span class="hljs-number">4</span>) <span class="hljs-literal">NULL</span>,
    DEC_PROP_2    <span class="hljs-built_in">NUMERIC</span>(<span class="hljs-number">13</span>, <span class="hljs-number">4</span>) <span class="hljs-literal">NULL</span>,
    BOOL_PROP_1   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-literal">NULL</span>,
    BOOL_PROP_2   <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
        <span class="hljs-keyword">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_BLOB_TRIGGERS
(
    SCHED_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    BLOB_DATA     <span class="hljs-built_in">BLOB</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">INDEX</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP),
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
        <span class="hljs-keyword">REFERENCES</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_CALENDARS
(
    SCHED_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    CALENDAR_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    CALENDAR      <span class="hljs-built_in">BLOB</span>         <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, CALENDAR_NAME)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_PAUSED_TRIGGER_GRPS
(
    SCHED_NAME    <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, TRIGGER_GROUP)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_FIRED_TRIGGERS
(
    SCHED_NAME        <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    ENTRY_ID          <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">95</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_NAME      <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    TRIGGER_GROUP     <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    INSTANCE_NAME     <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    FIRED_TIME        <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    SCHED_TIME        <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">PRIORITY</span>          <span class="hljs-built_in">INTEGER</span>      <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    STATE             <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    JOB_NAME          <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-literal">NULL</span>,
    JOB_GROUP         <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-literal">NULL</span>,
    IS_NONCONCURRENT  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-literal">NULL</span>,
    REQUESTS_RECOVERY <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, ENTRY_ID)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_SCHEDULER_STATE
(
    SCHED_NAME        <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    INSTANCE_NAME     <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">190</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    LAST_CHECKIN_TIME <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    CHECKIN_INTERVAL  <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">13</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, INSTANCE_NAME)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> QRTZ_LOCKS
(
    SCHED_NAME <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">120</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    LOCK_NAME  <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">40</span>)  <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (SCHED_NAME, LOCK_NAME)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_J_REQ_RECOVERY <span class="hljs-keyword">ON</span> QRTZ_JOB_DETAILS (SCHED_NAME, REQUESTS_RECOVERY);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_J_GRP <span class="hljs-keyword">ON</span> QRTZ_JOB_DETAILS (SCHED_NAME, JOB_GROUP);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_J <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, JOB_NAME, JOB_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_JG <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, JOB_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_C <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, CALENDAR_NAME);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_G <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_STATE <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_STATE);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_N_STATE <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP, TRIGGER_STATE);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_N_G_STATE <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_GROUP, TRIGGER_STATE);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_NEXT_FIRE_TIME <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, NEXT_FIRE_TIME);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_NFT_ST <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, TRIGGER_STATE, NEXT_FIRE_TIME);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_NFT_MISFIRE <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME, TRIGGER_STATE);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE_GRP <span class="hljs-keyword">ON</span> QRTZ_TRIGGERS (SCHED_NAME, MISFIRE_INSTR, NEXT_FIRE_TIME, TRIGGER_GROUP,
                                                             TRIGGER_STATE);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_TRIG_INST_NAME <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, INSTANCE_NAME);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_INST_JOB_REQ_RCVRY <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, INSTANCE_NAME, REQUESTS_RECOVERY);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_J_G <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, JOB_NAME, JOB_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_JG <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, JOB_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_T_G <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, TRIGGER_NAME, TRIGGER_GROUP);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> IDX_QRTZ_FT_TG <span class="hljs-keyword">ON</span> QRTZ_FIRED_TRIGGERS (SCHED_NAME, TRIGGER_GROUP);

<span class="hljs-keyword">commit</span>;
</code></pre>
<p>接下来可依次运行server服务(如若需要)、dashboard服务和示例项目。server服务和dashboard服务可以通过下载<a href="https://github.com/changmingxie/aggregate-framework">AGG源码</a>编译运行。也可直接在本地部署相应jar包，详见<a href="/zh-cn/aggdocs/ops/server/index.html">server部署</a>和<a href="/zh-cn/aggdocs/ops/dashboard/index.html">dashboard部署</a>。<br>
项目正常运行后，可通过访问<a href="http://localhost:22332/aggregate-framework-dashboard">http://localhost:22332/aggregate-framework-dashboard</a>，进入管理后台。用户名密码分别为admin和123456。<br>
<img src="../img/dashboard_index.png" alt="管理后台首页">
在Domain管理一栏中可以看到示例项目的domain信息，配置事件堆积处理、告警策略。
<img src="../img/dashboard_domin.png" alt="管理后台-Domain管理">
在事件管理一栏中可以，选中当前domain，即可处理该domain下堆积的事件，显然此时并没有。
<img src="../img/dashboard_event1.png" alt="管理后台-事件管理1">
在任务管理一栏中可以，可以启停或调整事件恢复任务的执行频率，需要注意的是该功能目前只支持<strong>server模式</strong>。
<img src="../img/dashboard_task.png" alt="管理后台-任务管理">
有关管理后台的详细介绍，可查看<a href="/zh-cn/aggdocs/ops/dashboard/dashboard-guild.html">dashboard使用手册</a>。<br>
<br/>
尝试调用创建账户的api <a href="http://localhost:8080/aggregate-framework-basic-usage/account/create">http://localhost:8080/aggregate-framework-basic-usage/account/create</a>，页面的返回值为accountId。<br>
<img src="../img/democase1.png" alt="示例图1">
然后立刻调用账户查询的api<a href="http://localhost:8080/aggregate-framework-basic-usage/account/query?accountId=***">http://localhost:8080/aggregate-framework-basic-usage/account/query?accountId=***</a>(使用先前返回的accountId来替换***)，页面的返回值即为先前创建的账户信息。账户信息的状态有一定概率不为3。<br>
<img src="../img/democase2.png" alt="示例图2">
查询管理后台事件管理一栏，可以观察到发生了事件堆积，且项目日志中打印了乐观锁异常。这是由于示例项目中故意使用了两个事件处理器来同时修改账户的状态，从而造成了并发冲突。
<img src="../img/democase3.png" alt="示例图3">
<img src="../img/democase4.png" alt="示例图4">
等待30-60秒后再次观察可以发现堆积的事件重试成功，账户信息的状态被修改成3，从而达到最终一致性。<br>
<img src="../img/democase5.png" alt="示例图5">
<img src="../img/democase6.png" alt="示例图6">
<br/>
也可访问<a href="http://localhost:8080/aggregate-framework-basic-usage/h2-console/login.jsp?jsessionid=943c595f39ca676919021daba287aa8a">H2管理后台</a>直接查看数据库中的记录，做进一步观察。(JDBC URL为 jdbc:h2:mem:AGG_TEST，用户名为root，密码为welcome1)<br>
<img src="../img/democase7.png" alt="示例图7"></p>
<h2 id="%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE">示例项目 <a class="header-anchor" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE">#</a></h2>
<p>恭喜你完成了该教程，完整的项目代码可在此获取<a href="https://github.com/changmingxie/aggregate-framework/tree/master-4.x/aggregate-framework-tutorial-sample/aggregate-framework-basic-usage">aggregate-framework-basic-usage</a></p>
</div></section><footer class="footer-container"><div class="footer-body"><div class="cols-container"><div class="col col-12"><h3>免责声明</h3><p>TCC-TRANSACTION是一款开源的微服务架构下的TCC型分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/what-is-tcctransaction.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/tutorial/quickstart.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/tutorial/quickstart.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2022 TCC-TRANSACTION</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/aggDocumentation.js"></script>
</body>
</html>
