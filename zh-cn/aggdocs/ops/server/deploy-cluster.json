{
  "filename": "deploy-cluster.md",
  "__html": "<h1 id=\"server%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2\">server集群部署 <a class=\"header-anchor\" href=\"#server%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2\">#</a></h1>\n<p>适用于生产环境，需要保证高可用。<br>\n注册中心推荐使用：nacos、zookeeper<br>\n存储类型推荐使用： jdbc、 redis、shard-redis、redis-cluster<br>\n任务部署方式推荐采用：quartz集群模式</p>\n<p>以下以注册中心[nacos]+存储类型[redis]+任务部署类型[quartz集群模式]这种组合为例。</p>\n<h2 id=\"%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5\">准备阶段 <a class=\"header-anchor\" href=\"#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5\">#</a></h2>\n<p><strong>注意</strong>: 对于agg-server、nacos、redis、mysql正常情况是需要独立实例部署的，这里考虑到机器资源有限，暂时部署在同一机器上。</p>\n<h3 id=\"%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8nacos%E6%9C%8D%E5%8A%A1\">安装并启动nacos服务 <a class=\"header-anchor\" href=\"#%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8nacos%E6%9C%8D%E5%8A%A1\">#</a></h3>\n<p>地址为：127.0.0.1:8848</p>\n<h3 id=\"%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8redis%E6%9C%8D%E5%8A%A1\">安装并启动redis服务 <a class=\"header-anchor\" href=\"#%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8redis%E6%9C%8D%E5%8A%A1\">#</a></h3>\n<p>地址为：127.0.0.1:6379</p>\n<h3 id=\"%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8mysql%E6%9C%8D%E5%8A%A1\">安装并启动mysql服务 <a class=\"header-anchor\" href=\"#%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8mysql%E6%9C%8D%E5%8A%A1\">#</a></h3>\n<p>地址为：127.0.0.1:3306</p>\n<h3 id=\"%E5%88%9D%E5%A7%8B%E5%8C%96quartz%E6%95%B0%E6%8D%AE%E5%BA%93\">初始化quartz数据库 <a class=\"header-anchor\" href=\"#%E5%88%9D%E5%A7%8B%E5%8C%96quartz%E6%95%B0%E6%8D%AE%E5%BA%93\">#</a></h3>\n<p>这里使用mysql数据库，脚本请<a href=\"https://github.com/changmingxie/aggregate-framework/blob/master-4.x/aggregate-framework-server/src/main/dbscripts/db_init.sql\">查看</a></p>\n<h3 id=\"%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0release%E7%89%88%E6%9C%AC\">下载最新<a href=\"https://github.com/changmingxie/aggregate-framework/releases\">RELEASE</a>版本 <a class=\"header-anchor\" href=\"#%E4%B8%8B%E8%BD%BD%E6%9C%80%E6%96%B0release%E7%89%88%E6%9C%AC\">#</a></h3>\n<p>下载最新的安装包aggregate-framework-server-xxx.tar.gz</p>\n<h2 id=\"%E5%AE%9E%E4%BE%8B1%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8\">实例1安装并启动 <a class=\"header-anchor\" href=\"#%E5%AE%9E%E4%BE%8B1%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8\">#</a></h2>\n<h3 id=\"%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%88%9B%E5%BB%BAserver%E7%9B%AE%E5%BD%95%E5%B9%B6%E8%A7%A3%E5%8E%8B\">第一步 创建server目录并解压 <a class=\"header-anchor\" href=\"#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%88%9B%E5%BB%BAserver%E7%9B%AE%E5%BD%95%E5%B9%B6%E8%A7%A3%E5%8E%8B\">#</a></h3>\n<p><strong>创建server目录</strong></p>\n<pre><code class=\"language-shell\">makdir server \ncd  server  \n</code></pre>\n<p><strong>下载aggregate-framework-server-xxx.tar.gz</strong>，解压到server目录</p>\n<pre><code class=\"language-shell\">server % tar zxvf aggregate-framework-server-4.0.0-SNAPSHOT.tar.gz\nx conf/application.yaml\nx lib/aggregate-framework-server.jar\nx conf/\nx conf/logback.xml\nx bin/\nx bin/startup.sh\nx bin/startup.cmd\nx bin/shutdown.sh\nx bin/shutdown.cmd\nserver % tree\n.\n├── aggregate-framework-server-4.0.0-SNAPSHOT.tar.gz\n├── bin\n│   ├── shutdown.cmd\n│   ├── shutdown.sh\n│   ├── startup.cmd\n│   └── startup.sh\n├── conf\n│   ├── application.yaml\n│   └── logback.xml\n└── lib\n    └── aggregate-framework-server.jar\n\n3 directories, 8 files\nserver % \n</code></pre>\n<h3 id=\"%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E4%BF%AE%E6%94%B9application.yaml%E9%85%8D%E7%BD%AE\">第二步 修改application.yaml配置 <a class=\"header-anchor\" href=\"#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E4%BF%AE%E6%94%B9application.yaml%E9%85%8D%E7%BD%AE\">#</a></h3>\n<p><a href=\"/zh-cn/aggdocs/tutorial/configurations.html#server%E7%AB%AF\">参数说明详见</a><br>\n这里以注册中心[nacos]+存储类型[redis]+任务部署类型[quartz集群模式]为例，对应的application.yaml可如下</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">12332</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/${spring.application.name}</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-server</span>\n  <span class=\"hljs-attr\">autoconfigure:</span>\n    <span class=\"hljs-attr\">exclude:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">redis</span>\n      <span class=\"hljs-attr\">redis:</span>\n        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">6379</span>\n        <span class=\"hljs-attr\">database:</span> <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-attr\">pool-config:</span>\n          <span class=\"hljs-attr\">max-total:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">max-idle:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">min-idle:</span> <span class=\"hljs-number\">10</span>\n          <span class=\"hljs-attr\">max-wait-millis:</span> <span class=\"hljs-number\">300</span>\n    <span class=\"hljs-attr\">recovery:</span>\n      <span class=\"hljs-attr\">quartz-clustered:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">quartz-data-source-url:</span> <span class=\"hljs-string\">jdbc:mysql://localhost:3306/AGG_SERVER?useSSL=false&amp;allowPublicKeyRetrieval=true</span>\n      <span class=\"hljs-attr\">quartz-data-source-driver:</span> <span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n      <span class=\"hljs-attr\">quartz-data-source-user:</span> <span class=\"hljs-string\">root</span>\n      <span class=\"hljs-attr\">quartz-data-source-password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">max-retry-count:</span> <span class=\"hljs-number\">3</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">registry-address:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:2332</span>\n      <span class=\"hljs-attr\">registry-address-for-dashboard:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:12332</span>\n      <span class=\"hljs-attr\">registry-type:</span> <span class=\"hljs-string\">nacos</span>\n      <span class=\"hljs-attr\">cluster-name:</span> <span class=\"hljs-string\">default</span>\n      <span class=\"hljs-attr\">nacos:</span>\n        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span>\n    <span class=\"hljs-attr\">remoting:</span>\n      <span class=\"hljs-attr\">listen-port:</span> <span class=\"hljs-number\">2332</span>\n</code></pre>\n<h3 id=\"%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%90%AF%E5%8A%A8server\">第三步 启动server <a class=\"header-anchor\" href=\"#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%90%AF%E5%8A%A8server\">#</a></h3>\n<pre><code class=\"language-shell\">sh bin/startup.sh #执行sh bin/shutdown.sh来停止服务\n</code></pre>\n<h2 id=\"%E5%AE%9E%E4%BE%8B2%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8\">实例2安装并启动 <a class=\"header-anchor\" href=\"#%E5%AE%9E%E4%BE%8B2%E5%AE%89%E8%A3%85%E5%B9%B6%E5%90%AF%E5%8A%A8\">#</a></h2>\n<p>参考<strong>实例1安装并启动</strong>\napplication.yaml可如下</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">server:</span>\n  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">12333</span>\n  <span class=\"hljs-attr\">servlet:</span>\n    <span class=\"hljs-attr\">context-path:</span> <span class=\"hljs-string\">/${spring.application.name}</span>\n\n<span class=\"hljs-attr\">logging:</span>\n  <span class=\"hljs-attr\">level:</span>\n    <span class=\"hljs-attr\">root:</span> <span class=\"hljs-string\">info</span>\n\n<span class=\"hljs-attr\">spring:</span>\n  <span class=\"hljs-attr\">application:</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">aggregate-framework-server</span>\n  <span class=\"hljs-attr\">autoconfigure:</span>\n    <span class=\"hljs-attr\">exclude:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration</span>\n  <span class=\"hljs-attr\">agg:</span>\n    <span class=\"hljs-attr\">storage:</span>\n      <span class=\"hljs-attr\">storage-type:</span> <span class=\"hljs-string\">redis</span>\n      <span class=\"hljs-attr\">redis:</span>\n        <span class=\"hljs-attr\">host:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span>\n        <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">6379</span>\n        <span class=\"hljs-attr\">database:</span> <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-attr\">pool-config:</span>\n          <span class=\"hljs-attr\">max-total:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">max-idle:</span> <span class=\"hljs-number\">100</span>\n          <span class=\"hljs-attr\">min-idle:</span> <span class=\"hljs-number\">10</span>\n          <span class=\"hljs-attr\">max-wait-millis:</span> <span class=\"hljs-number\">300</span>\n    <span class=\"hljs-attr\">recovery:</span>\n      <span class=\"hljs-attr\">quartz-clustered:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">quartz-data-source-url:</span> <span class=\"hljs-string\">jdbc:mysql://localhost:3306/AGG_SERVER?useSSL=false&amp;allowPublicKeyRetrieval=true</span>\n      <span class=\"hljs-attr\">quartz-data-source-driver:</span> <span class=\"hljs-string\">com.mysql.jdbc.Driver</span>\n      <span class=\"hljs-attr\">quartz-data-source-user:</span> <span class=\"hljs-string\">root</span>\n      <span class=\"hljs-attr\">quartz-data-source-password:</span> <span class=\"hljs-number\">123456</span>\n      <span class=\"hljs-attr\">max-retry-count:</span> <span class=\"hljs-number\">3</span>\n    <span class=\"hljs-attr\">registry:</span>\n      <span class=\"hljs-attr\">registry-address:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:2333</span>\n      <span class=\"hljs-attr\">registry-address-for-dashboard:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:12333</span>\n      <span class=\"hljs-attr\">registry-type:</span> <span class=\"hljs-string\">nacos</span>\n      <span class=\"hljs-attr\">cluster-name:</span> <span class=\"hljs-string\">default</span>\n      <span class=\"hljs-attr\">nacos:</span>\n        <span class=\"hljs-attr\">server-addr:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8848</span>\n    <span class=\"hljs-attr\">remoting:</span>\n      <span class=\"hljs-attr\">listen-port:</span> <span class=\"hljs-number\">2333</span>\n</code></pre>\n<h2 id=\"%E9%AA%8C%E8%AF%81\">验证 <a class=\"header-anchor\" href=\"#%E9%AA%8C%E8%AF%81\">#</a></h2>\n<p>实例1和实例2正常启动后，会在nacos显示如下信息。\n<img src=\"../../img/nacos_server_list.png\" alt=\"nacos服务列表\">\n<strong>netty-server实例注册成功</strong>，见下图\n<img src=\"../../img/nacos_agg_server_instances1.png\" alt=\"netty-server实例\">\n<strong>web实例注册成功</strong>，见下图\n<img src=\"../../img/nacos_agg_server_instances2.png\" alt=\"web实例\"></p>\n<p>恭喜你，server集群模式搭建完成！</p>\n",
  "link": "/zh-cn/aggdocs/ops/server/deploy-cluster.html",
  "meta": {}
}